<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to right, #141e30, #243b55);
      color: white;
      text-align: center;
      padding: 40px;
    }
    h1 { font-size: 3rem; color: #00ffcc; }
    .section { margin-top: 30px; }
    button {
      padding: 15px 25px;
      margin: 10px;
      font-size: 1.2rem;
      background-color: #007bff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
    }
    .button-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      max-width: 800px;
      margin: auto;
    }
    .hidden { display: none; }
    .selected { background-color: #00cc88 !important; }
    #countdown, #round, #winner {
      font-size: 1.8rem;
      margin-top: 20px;
    }
    #chart-container {
      width: 100%;
      max-width: 900px;
      margin: 30px auto;
    }
    #finalResult {
      font-size: 1.6rem;
      color: gold;
      margin-top: 30px;
      display: none;
      white-space: pre-line;
      text-align: right;
      line-height: 2.2rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
      width: 60%;
      margin-inline: auto;
    }
    #crownAnimation {
      font-size: 3rem;
      color: gold;
      font-weight: bold;
      animation: pulse 1.5s infinite;
      margin-top: 40px;
    }
    @keyframes pulse {
      0% { transform: scale(1); text-shadow: 0 0 10px gold; }
      50% { transform: scale(1.3); text-shadow: 0 0 20px yellow; }
      100% { transform: scale(1); text-shadow: 0 0 10px gold; }
    }
    #final-controls {
      display: none;
      margin-top: 40px;
    }
    #final-controls button {
      background-color: #6a1b9a;
    }
    #losers-panel {
      margin-top: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      display: none;
    }
    .loser-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.1);
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
    }
    .loser-name {
      font-weight: bold;
      margin-right: 10px;
    }
    .loser-punishment {
      flex-grow: 1;
      margin: 0 15px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      text-align: center;
    }
    .loser-buttons button {
      padding: 8px 12px;
      font-size: 0.9rem;
      margin: 0 5px;
    }
    .punishment-spinner {
      animation: flash-colors 0.3s infinite alternate;
    }
    @keyframes flash-colors {
      from { background-color: rgba(106, 27, 154, 0.2); }
      to { background-color: rgba(106, 27, 154, 0.5); }
    }
    .punishment-final {
      background: rgba(76, 175, 80, 0.3) !important;
    }
    .loser-applied {
      opacity: 0.6;
    }
    .batch-actions {
      margin-top: 20px;
    }
    .batch-actions button {
      background-color: #f57c00;
    }
  </style>
</head>
<body>
  <!-- Ø§Ù„Ø£ØµÙˆØ§Øª -->
  <audio id="bgMusic" loop><source src="/static/manager.mp3" type="audio/mpeg"></audio>
  <audio id="startSound"><source src="/static/start.mp3" type="audio/mpeg"></audio>
  <audio id="roundSound"><source src="/static/jola.mp3" type="audio/mpeg"></audio>
  <audio id="alarmSound"><source src="/static/Alarm.mp3" type="audio/mpeg"></audio>
  <audio id="crownSound"><source src="/static/foozzz.mp3" type="audio/mpeg"></audio>

  <h1>ğŸ‰ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ!</h1>

  <!-- Ø§Ù„Ø´Ø§Ø´Ø§Øª -->
  <div id="welcomeScreen" class="section">
    <button onclick="startGameSetup()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  </div>

  <div id="playerCountScreen" class="section hidden">
    <h2>ğŸ§ Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</h2>
    <div id="playerButtons" class="button-grid"></div>
  </div>

  <div id="punishmentsScreen" class="section hidden">
    <h2>ğŸ¯ Ø§Ø®ØªØ± Ø§Ù„Ø£Ø­ÙƒØ§Ù… (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† - 1)</h2>
    <div id="punishmentButtons" class="button-grid"></div>
    <div id="punishmentNote" style="color: gold; margin-top: 10px;"></div>
    <button id="startRegistrationBtn" class="hidden" onclick="goToDashboard()">âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  </div>

  <div id="dashboardScreen" class="section hidden">
    <div id="countdown"></div>
    <div id="round"></div>
    <div id="chart-container"><canvas id="progressChart"></canvas></div>
    <div id="winner"></div>
    <div id="crownAnimation" class="hidden"></div>
  </div>

  <div id="final-controls" class="section hidden">
    <h2>ğŸ¬ ØªØ­ÙƒÙ… Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
    <button onclick="replayCrown()">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØªÙˆÙŠØ¬</button>
    <button onclick="toggleLosersPanel()">ğŸ‘ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†</button>
    <button onclick="chooseLoserManually()">ğŸ¯ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ù„Ù„Ø®Ø³Ø§Ø±Ø©</button>
    <button onclick="spinAllPunishments()">âš¡ ØªØ¯ÙˆÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙƒØ§Ù…</button>
    <button onclick="applyAllPunishments()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙƒØ§Ù…</button>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
  <div id="losers-panel">
    <h3>ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‚ÙˆØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†</h3>
    <div id="losers-container"></div>
    <div class="batch-actions">
      <button onclick="spinAllPunishments()">ğŸ² ØªØ¯ÙˆÙŠØ± ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</button>
      <button onclick="applyAllPunishments()">âœ… ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</button>
    </div>
  </div>

  <div id="finalResult"></div>

  <script>
    const socket = io();
    let selectedPlayerCount = 0;
    let selectedPunishments = [];
    let usedPunishments = [];
    let chart;
    const chartData = {
      labels: [],
      datasets: [{ label: 'Ø§Ù„Ù†Ù‚Ø§Ø·', data: [], backgroundColor: [] }]
    };
    
    // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª
    let losersData = [];

    const bgMusic = document.getElementById("bgMusic");
    const startSound = document.getElementById("startSound");
    const roundSound = document.getElementById("roundSound");
    const alarmSound = document.getElementById("alarmSound");
    const crownSound = document.getElementById("crownSound");

    window.addEventListener("click", () => {
      bgMusic.muted = false;
      bgMusic.volume = 0.5;
      bgMusic.play().catch(() => {});
    }, { once: true });

    function startGameSetup() {
      bgMusic.play().catch(() => {});
      goToPlayerCount();
    }

    function goToPlayerCount() {
      document.getElementById("welcomeScreen").classList.add("hidden");
      document.getElementById("playerCountScreen").classList.remove("hidden");
      const container = document.getElementById("playerButtons");
      container.innerHTML = "";
      for (let i = 2; i <= 30; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.onclick = () => { selectedPlayerCount = i; goToPunishments(); };
        container.appendChild(btn);
      }
    }

    function goToPunishments() {
      document.getElementById("playerCountScreen").classList.add("hidden");
      document.getElementById("punishmentsScreen").classList.remove("hidden");
      const container = document.getElementById("punishmentButtons");
      container.innerHTML = "";
      selectedPunishments = [];
      usedPunishments = [];
      
      // Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØµØµØ© Ù…Ù† Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª
      const punishmentsList = [
  "Ù‚Ù… Ø¨ØªÙ‚Ù„ÙŠØ¯ ØµÙˆØª Ø­ÙŠÙˆØ§Ù† Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†Ù",
  "ØªØ­Ø¯Ø« Ø¨Ù„Ù‡Ø¬Ø© Ø®Ù„ÙŠØ¬ÙŠØ© Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§ Ù„Ù…Ø¯Ø© 3 Ø¯Ù‚Ø§Ø¦Ù‚",
  "Ù‚Ù… Ø¨Ø§Ù„Ø±Ù‚Øµ Ø¹Ù„Ù‰ Ø£ØºÙ†ÙŠØ© 'Ø´ÙˆÙ Ø¹ÙŠÙ†ÙŠ Ø´ÙˆÙ' Ù„Ù…Ø¯Ø© 30 Ø«Ø§Ù†ÙŠØ©",
  "Ù‚Ù Ø¹Ù„Ù‰ Ù‚Ø¯Ù… ÙˆØ§Ø­Ø¯Ø© Ù„Ù…Ø¯Ø© 30 Ø«Ø§Ù†ÙŠØ©",
  "Ø§Ø­ÙƒÙ Ù†ÙƒØªØ© Ù…Ø¶Ø­ÙƒØ©",
  "Ø§Ø±Ù‚Øµ Ø¹Ù„Ù‰ Ø£ØºÙ†ÙŠØ© 'Ù‡Ø² Ù‡Ø² Ù‡Ø²' Ù…Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØªÙÙŠÙ† ÙÙ‚Ø·",
  "ØªØ­Ø¯Ø« Ø¨Ø´ÙƒÙ„ Ø¹ÙƒØ³ÙŠ Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©",
  "Ù‚Ù… Ø¨ØªÙ…Ø«ÙŠÙ„ Ù…Ø´Ù‡Ø¯ Ø§Ù„ØµØ±Ø§Ø® Ø§Ù„Ø´Ù‡ÙŠØ± Ù…Ù† ÙÙŠÙ„Ù… 'Ù‡ÙˆÙ… Ø£Ù„ÙˆÙ†'",
  "Ù‚Ù… Ø¨Ù€ 10 ØªÙ…Ø§Ø±ÙŠÙ† Ø¶ØºØ· Ù…Ø¹ Ø§Ù„ØªØµÙÙŠÙ‚ Ø¨ÙŠÙ† ÙƒÙ„ Ø¹Ø¯Ø©",
  "ØªØ¸Ø§Ù‡Ø± Ø¨Ø£Ù†Ùƒ Ù…Ø°ÙŠØ¹ Ù†Ø´Ø±Ø© Ø£Ø®Ø¨Ø§Ø± ÙˆÙ‚Ù… Ø¨ØªØºØ·ÙŠØ© Ø¢Ø®Ø± Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø­ÙÙ„Ø©",
  "Ø§Ø´Ø±Ø¨ ÙƒÙˆØ¨ Ù…Ø§Ø¡ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙŠØ¯ÙŠÙƒ",
  "ØµÙÙ‚ 20 Ù…Ø±Ø© Ù…ØªØªØ§Ù„ÙŠØ©",
  "Ù‚Ù„Ù‘Ø¯ ØµÙˆØª Ø´Ø®ØµÙŠØ© Ø³Ø¨ÙˆÙ†Ø¬ Ø¨ÙˆØ¨ Ù…Ø¹ ØªØ¹Ø¨ÙŠØ±Ø§Øª ÙˆØ¬Ù‡ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©",
  "Ø§Ø°ÙƒØ± 5 Ø£Ø´ÙŠØ§Ø¡ ØªØ­Ø¨Ù‡Ø§ ÙÙŠ 10 Ø«ÙˆØ§Ù†Ù",
  "Ø§Ù…Ø´Ù ÙƒØ§Ù„Ø¨Ø·Ø© Ù„Ù…Ø¯Ø© 15 Ø«Ø§Ù†ÙŠØ©",
  "Ø§Ù…Ø¯Ø­ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ†Ùƒ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§",
  "ØºÙ†Ù‘ÙŠ Ù…Ù‚Ø·Ø¹ Ù…Ù† Ø£ØºÙ†ÙŠØ© 'Ø¨Ø¹Ø¯Ùˆ' Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆØ¨Ø±Ø§",
  "Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙƒØ«Ø± Ù…ÙˆÙ‚Ù Ù…Ø­Ø±Ø¬ Ø­Ø¯Ø« Ù„Ùƒ ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",
  "Ù‚Ù„Ø¯ Ø·Ø±ÙŠÙ‚Ø© Ù…Ø´ÙŠ Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ø®Ø§Øµ Ù…Ù† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†",
  "Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ù‹Ø§ Ø¨Ø¹ÙŠÙ†ÙŠÙƒ Ù…ØºÙ…Ø¶ØªÙŠÙ†",
  "Ø§Ø°ÙƒØ± 3 Ø£ÙÙ„Ø§Ù… ÙÙŠ 5 Ø«ÙˆØ§Ù†Ù",
  "Ø§ØµÙ†Ø¹ Ù†Ø¸Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ø¨ØµÙ„ ÙˆØ§Ø±ØªØ¯ÙŠÙ‡Ø§ Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©",
  "ØªØ­Ø¯Ø« Ø¨ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§ Ù„Ù…Ø¯Ø© 30 Ø«Ø§Ù†ÙŠØ©",
  "Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ Ù…Ø¶Ø­ÙƒØ© Ù…Ø¹ Ø´Ø®ØµÙŠÙ† Ù…Ù† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†",
  "Ù‚Ù„ Ø«Ù„Ø§Ø«Ø© Ø£Ø´ÙŠØ§Ø¡ Ø¨Ù„Ù‡Ø¬Ø© Ù…ØµØ±ÙŠØ©",
  "Ø­Ø§ÙˆÙ„ Ø£Ù† ØªÙ„Ù…Ø³ Ø£Ù†ÙÙƒ Ø¨Ù„Ø³Ø§Ù†Ùƒ",
  "ØªØµØ±Ù ÙƒØ£Ù†Ùƒ Ù‚Ø·Ø© Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø©ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…ÙˆØ§Ø¡ ÙˆØªÙ†Ø¸ÙŠÙ Ù†ÙØ³Ùƒ",
  "Ù‚Ù Ù„Ù…Ø¯Ø© 30 Ø«Ø§Ù†ÙŠØ© ÙˆØªØµØ±Ù ÙƒØªÙ…Ø«Ø§Ù„",
  "Ù‚Ù… Ø¨Ø¹Ù…Ù„ ØªØ¹Ø¨ÙŠØ±Ø§Øª ÙˆØ¬Ù‡ Ù…Ø¶Ø­ÙƒØ© Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†Ù",
  "Ø§ØªØ±Ùƒ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† ÙŠØ±Ø³Ù…ÙˆÙ† Ø¹Ù„Ù‰ Ø¸Ù‡Ø±Ùƒ Ø¨Ø§Ù„Ù‚Ù„Ù…"
];

      punishmentsList.forEach(pun => {
        const btn = document.createElement("button");
        btn.textContent = pun;
        btn.classList.add("punishment-button");
        btn.onclick = () => selectPunishment(btn, pun);
        container.appendChild(btn);
      });
    }

    function selectPunishment(btn, pun) {
      if (selectedPunishments.includes(pun)) {
        selectedPunishments = selectedPunishments.filter(p => p !== pun);
        btn.classList.remove("selected");
      } else {
        if (selectedPunishments.length < selectedPlayerCount - 1) {
          selectedPunishments.push(pun);
          btn.classList.add("selected");
        }
      }
      const note = document.getElementById("punishmentNote");
      if (selectedPunishments.length >= selectedPlayerCount - 1) {
        note.textContent = "âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø£Ø­ÙƒØ§Ù…. ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
        document.getElementById("startRegistrationBtn").classList.remove("hidden");
      } else {
        note.textContent = `Ø§Ø®ØªØ± Ø­ØªÙ‰ ${selectedPlayerCount - 1} Ø£Ø­ÙƒØ§Ù…. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${selectedPlayerCount - 1 - selectedPunishments.length}`;
        document.getElementById("startRegistrationBtn").classList.add("hidden");
      }
    }

    function goToDashboard() {
      document.getElementById("punishmentsScreen").classList.add("hidden");
      document.getElementById("dashboardScreen").classList.remove("hidden");
      socket.emit("selected_punishments", selectedPunishments);
      let seconds = 30;
      const countdownEl = document.getElementById("countdown");
      const countdown = setInterval(() => {
        countdownEl.textContent = `âŒ›ï¸ ØªØ¨Ù‚Ù‰ ${seconds} Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ³Ø¬ÙŠÙ„...`;
        seconds--;
        if (seconds < 0) {
          clearInterval(countdown);
          countdownEl.textContent = "âœ… Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„!";
          bgMusic.pause();
          startSound.play().catch(() => {});
          socket.emit("start_game_signal");
        }
      }, 1000);
    }

    // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†
    function toggleLosersPanel() {
      const panel = document.getElementById("losers-panel");
      if (panel.style.display === "none" || panel.style.display === "") {
        panel.style.display = "block";
        updateLosersPanel();
      } else {
        panel.style.display = "none";
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†
    function updateLosersPanel() {
      const container = document.getElementById("losers-container");
      container.innerHTML = "";
      
      if (losersData.length === 0) {
        container.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø®Ø§Ø³Ø±ÙŠÙ† Ø¨Ø¹Ø¯</p>";
        return;
      }
      
      losersData.forEach((loser, index) => {
        const row = document.createElement("div");
        row.className = `loser-row ${loser.applied ? 'loser-applied' : ''}`;
        row.id = `loser-row-${index}`;
        
        // Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
        const nameSpan = document.createElement("div");
        nameSpan.className = "loser-name";
        nameSpan.textContent = loser.name;
        
        // Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
        const punishmentSpan = document.createElement("div");
        punishmentSpan.className = loser.punishment ? 
          `loser-punishment ${loser.isSpinning ? 'punishment-spinner' : 'punishment-final'}` : 
          "loser-punishment";
        punishmentSpan.textContent = loser.punishment || "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¹Ù‚ÙˆØ¨Ø© Ø¨Ø¹Ø¯";
        punishmentSpan.id = `punishment-${index}`;
        
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        const buttons = document.createElement("div");
        buttons.className = "loser-buttons";
        
        // Ø²Ø± Ø§Ù„ØªØ¯ÙˆÙŠØ±
        const spinBtn = document.createElement("button");
        spinBtn.textContent = "ğŸ² ØªØ¯ÙˆÙŠØ±";
        spinBtn.disabled = loser.applied;
        spinBtn.onclick = () => spinPunishment(index);
        
        // Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const applyBtn = document.createElement("button");
        applyBtn.textContent = "âœ“ ØªØ·Ø¨ÙŠÙ‚";
        applyBtn.disabled = !loser.punishment || loser.applied;
        applyBtn.onclick = () => applyPunishment(index);
        
        buttons.appendChild(spinBtn);
        buttons.appendChild(applyBtn);
        
        row.appendChild(nameSpan);
        row.appendChild(punishmentSpan);
        row.appendChild(buttons);
        
        container.appendChild(row);
      });
    }

    // ØªØ¯ÙˆÙŠØ± Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø¹ÙŠÙ†
    function spinPunishment(loserIndex) {
      if (!losersData[loserIndex]) return;
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±
      losersData[loserIndex].isSpinning = true;
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
      let remaining = selectedPunishments.filter(p => !usedPunishments.includes(p));
      if (remaining.length === 0) {
        remaining = [...selectedPunishments]; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª
        usedPunishments = [];
      }
      
      // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯ÙˆÙŠØ±
      let i = 0;
      const maxSpins = 20;
      const interval = setInterval(() => {
        if (!document.getElementById(`punishment-${loserIndex}`)) {
          clearInterval(interval);
          return;
        }
        
        const randomPunishment = remaining[Math.floor(Math.random() * remaining.length)];
        document.getElementById(`punishment-${loserIndex}`).textContent = randomPunishment;
        
        i++;
        if (i >= maxSpins) {
          clearInterval(interval);
          
          // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
          const finalPunishment = document.getElementById(`punishment-${loserIndex}`).textContent;
          losersData[loserIndex].punishment = finalPunishment;
          losersData[loserIndex].isSpinning = false;
          usedPunishments.push(finalPunishment);
          
          // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          const punishmentElement = document.getElementById(`punishment-${loserIndex}`);
          if (punishmentElement) {
            punishmentElement.classList.remove("punishment-spinner");
            punishmentElement.classList.add("punishment-final");
          }
          
          updateLosersPanel();
        }
      }, 100);
    }

    // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    function spinAllPunishments() {
      losersData.forEach((loser, index) => {
        if (!loser.applied) {
          setTimeout(() => spinPunishment(index), index * 400);
        }
      });
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù‚ÙˆØ¨Ø© Ø¹Ù„Ù‰ Ù„Ø§Ø¹Ø¨ Ù…Ø¹ÙŠÙ†
    function applyPunishment(loserIndex) {
      const loser = losersData[loserIndex];
      if (!loser || !loser.punishment || loser.applied) return;
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
      socket.emit("set_final_loser", { loser: loser.name });
      socket.emit("final_apply_punishment", { 
        loser: loser.name, 
        punishment: loser.punishment 
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      loser.applied = true;
      document.getElementById(`finalResult`).style.display = "block";
      document.getElementById(`finalResult`).textContent += `\nğŸ¯ ${loser.name}: ${loser.punishment}`;
      
      updateLosersPanel();
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª
    function applyAllPunishments() {
      const unappliedWithPunishment = losersData.filter(
        loser => loser.punishment && !loser.applied
      );
      
      if (unappliedWithPunishment.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­ÙƒØ§Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚!");
        return;
      }
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù…
      const allPunishmentsToApply = unappliedWithPunishment.map(loser => ({
        loser: loser.name,
        punishment: loser.punishment
      }));
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù…
      socket.emit("apply_all_punishments", { punishments: allPunishmentsToApply });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      let resultText = "";
      unappliedWithPunishment.forEach(loser => {
        loser.applied = true;
        resultText += `\nğŸ¯ ${loser.name}: ${loser.punishment}`;
      });
      
      document.getElementById("finalResult").style.display = "block";
      document.getElementById("finalResult").textContent += resultText;
      
      updateLosersPanel();
    }

    socket.on("question_number", (num) => {
      document.getElementById("round").textContent = `ğŸ¯ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø±Ù‚Ù… ${num}`;
    });

    socket.on("start_countdown", ({ duration }) => {
      roundSound.play().catch(() => {});
    });

    socket.on("play_round_sound", () => {
      roundSound.play().catch(() => {});
    });

    socket.on("show_surprise_box", () => {
      alarmSound.play().catch(() => {});
    });

    socket.on("play_alarm_sound", () => {
      alarmSound.play().catch(() => {});
    });

    socket.on("new_player", ({ name }) => {
      chartData.labels.push(name);
      chartData.datasets[0].data.push(0);
      chartData.datasets[0].backgroundColor.push("#00ffcc");
      updateChart();
    });

    socket.on("leaderboard_chart", (players) => {
      players.forEach(p => {
        const index = chartData.labels.indexOf(p.name);
        if (index !== -1) {
          chartData.datasets[0].data[index] = p.score;
        }
      });
      updateChart();
    });

    socket.on("final_winner", (name) => {
      document.getElementById("winner").textContent = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‡Ùˆ: ${name}`;
      document.getElementById("final-controls").classList.remove("hidden");
    });

    socket.on("final_punishment", ({ loser, punishment }) => {
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©
      const existingLoser = losersData.find(l => l.name === loser);
      if (existingLoser) {
        existingLoser.punishment = punishment;
        existingLoser.applied = true;
      }
      
      updateLosersPanel();
    });

    socket.on("final_loser_selected", ({ loser }) => {
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      if (!losersData.find(l => l.name === loser)) {
        losersData.push({
          name: loser,
          punishment: null,
          isSpinning: false,
          applied: false
        });
      }
      
      updateLosersPanel();
    });

    socket.on("crown_winner", ({ name }) => {
      const crown = document.getElementById("crownAnimation");
      crown.textContent = `âœ¨âœ¨ ${name} âœ¨âœ¨`;
      crown.classList.remove("hidden");
      crownSound.play().catch(() => {});
    });

    function replayCrown() {
      socket.emit("replay_crown");
    }

    function chooseLoserManually() {
      const loser = prompt("ğŸ“Œ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø®Ø§Ø³Ø±:");
      if (loser) {
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†
        if (!losersData.find(l => l.name === loser)) {
          losersData.push({
            name: loser,
            punishment: null,
            isSpinning: false,
            applied: false
          });
        }
        
        socket.emit("set_final_loser", { loser });
        updateLosersPanel();
        
        // Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†
        document.getElementById("losers-panel").style.display = "block";
      }
    }

    function updateChart() {
      if (!chart) {
        const ctx = document.getElementById("progressChart").getContext("2d");
        chart = new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†' }
            },
            animation: { duration: 1000, easing: 'easeOutBounce' },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
          }
        });
      } else {
        chart.update();
      }
    }
  </script>
</body>
</html>