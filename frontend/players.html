<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØµÙØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root {
      --primary-color: #2962ff;
      --primary-dark: #0039cb;
      --primary-light: #768fff;
      --success-color: #00c853;
      --warning-color: #ffd600;
      --danger-color: #ff3d00;
      --bg-color: #f5f5f5;
      --card-bg: #ffffff;
      --text-color: #212121;
      --text-secondary: #757575;
      --border-radius: 12px;
      --shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      text-align: center;
      padding: 16px;
      transition: background-color 0.5s;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    @media screen and (max-width: 600px) {
      body {
        padding: 12px;
      }
    }

    body.shake {
      animation: shake 0.5s;
      background-color: #ffebee !important;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 16px;
      color: var(--primary-dark);
    }

    @media screen and (max-width: 480px) {
      h1 {
        font-size: 1.7rem;
      }
    }

    .container {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 16px;
    }

    .input-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    input[type="text"] {
      padding: 12px 16px;
      font-size: 1.1rem;
      width: 100%;
      max-width: 300px;
      border: 2px solid var(--primary-color);
      border-radius: var(--border-radius);
      font-family: 'Tajawal', sans-serif;
    }

    button {
      padding: 12px 20px;
      font-size: 1rem;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-weight: 500;
      transition: all 0.2s;
    }

    button:hover {
      background-color: var(--primary-dark);
    }

    button:disabled {
      background-color: #bdbdbd;
      cursor: not-allowed;
    }

    .status-box {
      font-weight: bold;
      font-size: 1.2rem;
      margin: 12px 0;
      padding: 12px;
      background-color: rgba(0, 41, 255, 0.05);
      border-radius: var(--border-radius);
      border-right: 4px solid var(--primary-color);
    }

    .player-score {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary-color);
      margin: 12px 0;
    }

    #countdown-timer {
      font-size: 1.5rem;
      color: var(--danger-color);
      margin: 16px auto;
      font-weight: bold;
    }

    #game-area {
      display: none;
      margin-top: 24px;
    }

    .question-box {
      background-color: var(--card-bg);
      margin-bottom: 20px;
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border-right: 4px solid var(--primary-light);
    }

    .question-text {
      font-weight: bold;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    @media screen and (max-width: 480px) {
      .options-grid {
        grid-template-columns: 1fr;
      }
    }

    .option {
      width: 100%;
      margin: 4px 0;
      padding: 10px;
      text-align: center;
      font-size: 1rem;
      border-radius: var(--border-radius);
      background-color: #f5f5f5;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.2s;
      color: #000000;
      font-weight: bold;
    }

    .option:hover {
      background-color: #e3f2fd;
    }

    .option.selected {
      background-color: #81c784 !important;
      color: #000000;
      font-weight: bold;
    }

    .result-message {
      font-size: 1.5rem;
      margin: 16px 0;
      padding: 12px;
      border-radius: var(--border-radius);
      display: none;
    }

    #loser {
      background-color: #ffebee;
      color: #c62828;
      border-right: 4px solid #f44336;
    }

    #winner {
      background-color: #e8f5e9;
      color: #2e7d32;
      border-right: 4px solid #4caf50;
    }

    #leaderboard {
      margin-top: 24px;
      font-size: 1rem;
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: right;
    }

    #leaderboard h3 {
      margin-bottom: 10px;
      color: var(--primary-dark);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 6px;
    }

    .highlight-punished {
      background-color: rgba(255, 0, 0, 0.05);
    }

    #finalPunishment {
      display: none;
      margin-top: 24px;
      font-size: 1.3rem;
      color: var(--warning-color);
      white-space: pre-line;
      padding: 16px;
      background-color: rgba(0, 0, 0, 0.8);
      border-radius: var(--border-radius);
    }

    #freeze-choice, #target-choice, #final-buttons, #final-losers, #flash-result {
      display: none;
      margin-top: 24px;
    }

    .interaction-panel {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-top: 16px;
    }

    .interaction-panel h3 {
      margin-bottom: 12px;
      color: var(--primary-dark);
    }

    .freeze-btn, .surprise-btn, .loser-btn {
      margin: 5px;
      padding: 10px 15px;
      font-size: 1rem;
      background-color: #00a0ff;
      color: white;
    }

    #surprise-box {
      display: none;
      margin-top: 20px;
      padding: 16px;
      background: #fff8e1;
      border: 2px dashed var(--warning-color);
      border-radius: var(--border-radius);
    }

    #surprise-box h3 {
      color: #ff8f00;
      margin-bottom: 12px;
    }

    .punishment-selector {
      display: flex;
      flex-direction: column;
      margin: 10px 0;
      background-color: #f0f0f0;
      padding: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }

    .punishment-spinner {
      text-align: center;
      font-weight: bold;
      padding: 12px;
      margin: 10px 0;
      background: #fff;
      border-radius: var(--border-radius);
      border: 1px dashed #ccc;
      min-height: 20px;
    }

    .spinning {
      background-color: #ffe0b2;
      animation: spin-color 0.3s infinite alternate;
    }

    @keyframes spin-color {
      from { background-color: #ffe0b2; }
      to { background-color: #ffcc80; }
    }

    .final-punishment {
      background-color: #e8f5e9;
      font-weight: bold;
      border: 1px solid #81c784;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© */
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-warning {
      background-color: var(--warning-color);
      color: #212121;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ® Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø©</h1>
    
    <div class="input-section">
      <input type="text" id="playerName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" maxlength="20">
      <div class="btn-group">
        <button onclick="registerPlayer()">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
        <button onclick="confirmReady()">ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
      </div>
    </div>
    
    <div id="status" class="status-box">ğŸ•“ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</div>
    <div id="player-score" class="player-score">ğŸ”¢ Ù†Ù‚Ø§Ø·Ùƒ: 0</div>
  </div>

  <div id="countdown-timer"></div>
  
  <div id="game-area"></div>
  
  <div id="loser" class="result-message">ğŸ’” Ø®Ø³Ø±Øª Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
  <div id="winner" class="result-message">ğŸ† ÙØ²Øª ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©!</div>
  
  <div id="leaderboard"></div>
  
  <div id="finalPunishment"></div>
  
  <div id="freeze-choice" class="interaction-panel">
    <h3>â„ï¸ Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„ØªØ¬Ù…ÙŠØ¯Ù‡:</h3>
    <div id="freezeButtons" class="btn-group"></div>
  </div>
  
  <div id="surprise-box" class="interaction-panel">
    <h3>ğŸ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª! Ø§Ø®ØªØ± Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª:</h3>
    <div class="btn-group">
      <button class="surprise-btn" onclick="chooseSurprise('freeze')">â„ï¸ ØªØ¬Ù…ÙŠØ¯ Ù„Ø§Ø¹Ø¨</button>
      <button class="surprise-btn" onclick="chooseSurprise('steal')">ğŸ’° Ø³Ø±Ù‚Ø© Ù†Ù‚Ø§Ø·</button>
      <button class="surprise-btn" onclick="chooseSurprise('swap')">ğŸ” ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
    </div>
  </div>
  
  <div id="target-choice" class="interaction-panel"></div>
  
  <div id="final-buttons" class="interaction-panel">
    <h2>ğŸ‘‘ ØªØ­ÙƒÙ…Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ§ Ø¨Ø·Ù„!</h2>
    <div class="btn-group">
      <button onclick="socket.emit('replay_crown')">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØªÙˆÙŠØ¬</button>
      <button onclick="showLosersAndPunishments()">ğŸ¯ Ø§Ø­ÙƒÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†</button>
      <button onclick="spinAllPunishments()">âš¡ ØªØ¯ÙˆÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø£Ø­ÙƒØ§Ù…</button>
      <button onclick="applyAllPunishments()" class="btn-success">âœ… ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙƒØ§Ù…</button>
    </div>
  </div>
  
  <div id="final-losers" class="interaction-panel">
    <h3>ğŸ¯ Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…:</h3>
    <div id="losers-container"></div>
    <button id="apply-all-btn" class="btn-success pulse" style="display:none; margin-top:15px;" onclick="applyAllPunishments()">ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙƒØ§Ù…</button>
  </div>
  
  <div id="flash-result" class="status-box pulse"></div>

  <script>
    const socket = io();
    let myName = "";
    let isFrozen = false;
    let eliminated = false;
    let currentAnswers = [];
    let countdownInterval;
    let lastScore = 0;
    let usedPunishments = [];
    let allPunishments = [];
    let losersData = [];
    
    function registerPlayer() {
      const name = document.getElementById("playerName").value.trim();
      if (name !== "") {
        myName = name;
        socket.emit("register_name", name);
        document.getElementById("status").textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…: ${name}`;
        document.getElementById("status").style.borderRight = "4px solid #00c853";
        document.getElementById("status").style.backgroundColor = "rgba(0, 200, 83, 0.1)";
      } else {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­");
      }
    }

    function confirmReady() {
      if (!myName) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }
      socket.emit("confirm_ready");
      document.querySelector(".input-section").style.display = "none";
      document.getElementById("status").textContent = "â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...";
      document.getElementById("status").style.borderRight = "4px solid #ffd600";
      document.getElementById("status").style.backgroundColor = "rgba(255, 214, 0, 0.1)";
    }

    socket.on("registration_ended", () => {
      document.getElementById("status").textContent = "ğŸš€ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª!";
      document.getElementById("status").style.borderRight = "4px solid #00c853";
      document.getElementById("status").style.backgroundColor = "rgba(0, 200, 83, 0.1)";
    });

    socket.on("round_questions", (questions) => {
      if (eliminated || isFrozen) return;
      document.getElementById("game-area").style.display = "block";
      document.getElementById("game-area").innerHTML = "";
      document.getElementById("surprise-box").style.display = "none";
      currentAnswers = new Array(questions.length).fill(null);

      questions.forEach((q, index) => {
        const box = document.createElement("div");
        box.className = "question-box";

        const qText = document.createElement("div");
        qText.className = "question-text";
        qText.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${q.question}`;
        box.appendChild(qText);

        const optionsGrid = document.createElement("div");
        optionsGrid.className = "options-grid";

        const btns = [];
        q.options.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "option";
          btn.textContent = opt;
          btn.onclick = () => {
            btns.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            currentAnswers[index] = opt;
            socket.emit("answer", { answer: opt, question_index: index });
          };
          btns.push(btn);
          optionsGrid.appendChild(btn);
        });

        box.appendChild(optionsGrid);
        document.getElementById("game-area").appendChild(box);
      });

      startCountdown(15);
    });

    function startCountdown(seconds) {
      clearInterval(countdownInterval);
      const countdownEl = document.getElementById("countdown-timer");
      countdownEl.style.display = "block";
      countdownEl.textContent = `â± ØªØ¨Ù‚Ù‰ ${seconds} Ø«Ø§Ù†ÙŠØ©!`;
      
      // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ Ù„Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
      countdownEl.classList.add("pulse");
      
      countdownInterval = setInterval(() => {
        seconds--;
        if (seconds <= 0) {
          clearInterval(countdownInterval);
          countdownEl.style.display = "none";
          countdownEl.classList.remove("pulse");
        } else {
          countdownEl.textContent = `â± ØªØ¨Ù‚Ù‰ ${seconds} Ø«Ø§Ù†ÙŠØ©!`;
          
          // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‚Ù„ÙŠÙ„Ø§Ù‹
          if (seconds <= 5) {
            countdownEl.style.color = "#ff3d00";
            countdownEl.style.fontSize = "1.7rem";
          }
        }
      }, 1000);
    }

    socket.on("you_won", () => {
      document.getElementById("winner").style.display = "block";
      socket.emit("i_am_final_winner");
    });

    socket.on("show_surprise_box", () => {
      document.getElementById("surprise-box").style.display = "block";
    });

    function chooseSurprise(type) {
      socket.emit("surprise_choice", { type });
      document.getElementById("surprise-box").style.display = "none";
    }

    socket.on("choose_target_player", ({ surprise_type, players }) => {
      const container = document.getElementById("target-choice");
      container.innerHTML = `<h3>ğŸ¯ Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙØ§Ø¬Ø£Ø©:</h3><div class="btn-group"></div>`;
      const buttonGroup = container.querySelector(".btn-group");
      
      players.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.className = "surprise-btn";
        btn.onclick = () => {
          socket.emit("surprise_target_selected", { type: surprise_type, target: name });
          container.innerHTML = "<div class='status-box' style='background-color:rgba(0, 200, 83, 0.1);border-right:4px solid #00c853;'>âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù…ÙØ§Ø¬Ø£Ø©!</div>";
        };
        buttonGroup.appendChild(btn);
      });
      container.style.display = "block";
    });

    socket.on("points_stolen", ({ from, to, amount }) => {
      document.getElementById("status").textContent = `ğŸ’° ${to} Ø³Ø±Ù‚ ${amount} Ù†Ù‚Ø·Ø© Ù…Ù† ${from}!`;
      document.getElementById("status").style.borderRight = "4px solid #ffd600";
      document.getElementById("status").style.backgroundColor = "rgba(255, 214, 0, 0.1)";
    });

    socket.on("points_swapped", ({ with: other }) => {
      document.getElementById("status").textContent = `ğŸ” ØªÙ… ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø¹ ${other}`;
      document.getElementById("status").style.borderRight = "4px solid #ffd600";
      document.getElementById("status").style.backgroundColor = "rgba(255, 214, 0, 0.1)";
    });

    socket.on("you_lost", () => {
      eliminated = true;
      document.getElementById("loser").style.display = "block";
      document.getElementById("game-area").style.display = "none";
      document.getElementById("status").textContent = "ğŸ’” Ø­Ø¸Ù‹Ø§ Ø£ÙˆÙØ±... Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ!";
      document.getElementById("status").style.borderRight = "4px solid #ff3d00";
      document.getElementById("status").style.backgroundColor = "rgba(255, 61, 0, 0.1)";
      document.body.classList.add("shake");
      setTimeout(() => document.body.classList.remove("shake"), 500);
    });

    socket.on("player_frozen", ({ by }) => {
      isFrozen = true;
      document.body.classList.add("highlight-punished");
      document.getElementById("status").innerHTML = `â„ï¸ ØªÙ… ØªØ¬Ù…ÙŠØ¯Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© <span style='color:#2962ff;font-weight:bold;'>${by}</span>`;
      document.getElementById("status").style.borderRight = "4px solid #2962ff";
      document.getElementById("status").style.backgroundColor = "rgba(41, 98, 255, 0.1)";
    });

    socket.on("ask_to_freeze", ({ players }) => {
      const freezeButtons = document.getElementById("freezeButtons");
      freezeButtons.innerHTML = "";
      players.forEach(name => {
        const btn = document.createElement("button");
        btn.className = "freeze-btn";
        btn.textContent = name;
        btn.onclick = () => {
          socket.emit("freeze_player", name);
          document.getElementById("freeze-choice").style.display = "none";
          document.getElementById("status").textContent = `â„ï¸ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${name} Ù„Ù„ØªØ¬Ù…ÙŠØ¯`;
          document.getElementById("status").style.borderRight = "4px solid #2962ff";
          document.getElementById("status").style.backgroundColor = "rgba(41, 98, 255, 0.1)";
        };
        freezeButtons.appendChild(btn);
      });
      document.getElementById("freeze-choice").style.display = "block";
    });

    socket.on("leaderboard_update", (players) => {
      const leaderboard = document.getElementById("leaderboard");
      leaderboard.innerHTML = '<h3>ğŸ… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>';
      
      players.forEach((p, i) => {
        const row = document.createElement("div");
        row.style.padding = "8px 0";
        row.style.borderBottom = i < players.length - 1 ? "1px solid #e0e0e0" : "none";
        
        // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø£ÙˆÙ„ Ø«Ù„Ø§Ø«Ø© Ù…Ø±Ø§ÙƒØ²
        if (i === 0) row.style.backgroundColor = "rgba(255, 215, 0, 0.1)";
        else if (i === 1) row.style.backgroundColor = "rgba(192, 192, 192, 0.1)";
        else if (i === 2) row.style.backgroundColor = "rgba(205, 127, 50, 0.1)";
        
        const rank = document.createElement("span");
        rank.style.fontWeight = "bold";
        rank.style.marginLeft = "10px";
        
        // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        if (i === 0) rank.textContent = "ğŸ¥‡ ";
        else if (i === 1) rank.textContent = "ğŸ¥ˆ ";
        else if (i === 2) rank.textContent = "ğŸ¥‰ ";
        else rank.textContent = `${i+1}. `;
        
        const nameSpan = document.createElement("span");
        nameSpan.textContent = p.name;
        if (p.name === myName) {
          nameSpan.style.fontWeight = "bold";
          nameSpan.style.color = "#2962ff";
        }
        
        const score = document.createElement("span");
        score.textContent = ` - ${p.score} Ù†Ù‚Ø·Ø©`;
        score.style.color = "#757575";
        
        row.appendChild(rank);
        row.appendChild(nameSpan);
        row.appendChild(score);
        leaderboard.appendChild(row);
      });

      const playerScore = players.find(p => p.name === myName);
      if (playerScore) {
        document.getElementById("player-score").textContent = `ğŸ”¢ Ù†Ù‚Ø§Ø·Ùƒ: ${playerScore.score}`;
        if (playerScore.score < lastScore) {
          document.body.classList.add("shake");
          setTimeout(() => document.body.classList.remove("shake"), 500);
        } else if (playerScore.score > lastScore) {
          // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¹Ù†Ø¯ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
          document.getElementById("player-score").classList.add("pulse");
          setTimeout(() => document.getElementById("player-score").classList.remove("pulse"), 1000);
        }
        lastScore = playerScore.score;
      }
    });

    socket.on("question_number", () => {
      document.body.classList.remove("highlight-punished");
      if (isFrozen) {
        document.body.style.backgroundColor = "#e3f2fd";
      } else {
        document.body.style.backgroundColor = "#f5f5f5";
      }
      document.getElementById("freeze-choice").style.display = "none";
    });

    socket.on("final_punishment", ({ loser, punishment }) => {
      document.getElementById("finalPunishment").style.display = "block";
      document.getElementById("finalPunishment").textContent = `ğŸ¯ Ø§Ù„Ø­ÙƒÙ… Ø¹Ù„Ù‰ ${loser}: ${punishment}`;
    });

    socket.on("final_stage_start", ({ players, punishments }) => {
      allPunishments = punishments || [];
      document.getElementById("final-buttons").style.display = "block";
      
      // ØªØ¬Ù‡ÙŠØ² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†
      if (players && players.length) {
        losersData = players.map(name => ({
          name,
          punishment: null,
          isSpinning: false,
          applied: false
        }));
      }
    });
    
    // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø¹Ù‚ÙˆØ¨Ø© Ù„ÙƒÙ„ Ù…Ù†Ù‡Ù…
    function showLosersAndPunishments() {
      const container = document.getElementById("losers-container");
      container.innerHTML = "";
      document.getElementById("final-losers").style.display = "block";
      
      if (losersData.length === 0) {
        container.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø®Ø§Ø³Ø±ÙŠÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§</p>";
        return;
      }
      
      losersData.forEach((loser, index) => {
        const row = document.createElement("div");
        row.className = "punishment-selector";
        row.id = `loser-row-${index}`;
        
        // Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
        const nameSpan = document.createElement("div");
        nameSpan.style.fontWeight = "bold";
        nameSpan.textContent = loser.name;
        
        // Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
        const punishmentSpan = document.createElement("div");
        punishmentSpan.id = `punishment-${index}`;
        punishmentSpan.className = loser.punishment ? "punishment-spinner final-punishment" : "punishment-spinner";
        punishmentSpan.textContent = loser.punishment || "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ¯ÙˆÙŠØ± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©";
        
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "btn-group";
        
        // Ø²Ø± Ø§Ù„ØªØ¯ÙˆÙŠØ±
        const spinBtn = document.createElement("button");
        spinBtn.textContent = "ğŸ² ØªØ¯ÙˆÙŠØ±";
        spinBtn.className = "btn-warning";
        spinBtn.onclick = () => spinPunishment(index);
        spinBtn.disabled = loser.applied;
        
        // Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const applyBtn = document.createElement("button");
        applyBtn.textContent = "âœ“ ØªØ·Ø¨ÙŠÙ‚";
        applyBtn.className = "btn-success";
        applyBtn.disabled = !loser.punishment || loser.applied;
        applyBtn.onclick = () => applyPunishment(index);
        
        buttonsDiv.appendChild(spinBtn);
        buttonsDiv.appendChild(applyBtn);
        
        row.appendChild(nameSpan);
        row.appendChild(punishmentSpan);
        row.appendChild(buttonsDiv);
        
        container.appendChild(row);
      });
      
      // Ø¹Ø±Ø¶ Ø²Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„
      document.getElementById("apply-all-btn").style.display = 
        losersData.some(loser => loser.punishment && !loser.applied) ? "block" : "none";
    }
    
    // ØªØ¯ÙˆÙŠØ± Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù…Ø¹ÙŠÙ†
    function spinPunishment(loserIndex) {
      const punishmentElement = document.getElementById(`punishment-${loserIndex}`);
      
      if (!punishmentElement) return;
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±
      losersData[loserIndex].isSpinning = true;
      punishmentElement.classList.add("spinning");
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
      let remaining = allPunishments.filter(p => !usedPunishments.includes(p));
      if (remaining.length === 0) {
        remaining = [...allPunishments]; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø¥Ø°Ø§ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙƒÙ„Ù‡Ø§
        usedPunishments = [];
      }
      
      // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ØµÙˆØªÙŠ Ù„Ù„ØªØ¯ÙˆÙŠØ±
      const spinSound = new Audio();
      spinSound.src = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAAFTgD///////////////////////////////////////////8AAAA8TEFNRTMuMTAwBK8AAAAAAAAAABSAJAUjjgAAgAAABU7DKYQrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAADwAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==";
      spinSound.play().catch(e => console.log("Audio play failed", e));
      
      let spinCount = 0;
      const maxSpins = 20;
      const spinInterval = setInterval(() => {
        const randomPunishment = remaining[Math.floor(Math.random() * remaining.length)];
        punishmentElement.textContent = randomPunishment;
        spinCount++;
        
        if (spinCount >= maxSpins) {
          clearInterval(spinInterval);
          punishmentElement.classList.remove("spinning");
          punishmentElement.classList.add("final-punishment");
          
          // ØªØ£Ø«ÙŠØ± Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¯ÙˆÙŠØ±
          const successSound = new Audio();
          successSound.src = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAADAAAHWgCVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZXz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/P///////////////////////////////////////////8AAAA8TEFNRTMuMTAwBK8AAAAAAAAAABSAJAZGkgAAgAAAB1oa2YRnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tAxAAAw8ABeAAAAA1oDzciEABmQAQDgMxHIIPn5+Hv4IFAYDhMJhRCCDDDCCIQQYdD4IMCgQCAIgRBgQCAIAgD8EAQBAEAQBGMYx/iAIAgCAIA+CAIAgCgZYQYEAgCAIAgD4IAgCAILF1EH4fLsIJMJWEGEEDcYsWNP/xYuos6iDCDDYaZ0CgQYQQQQQQQYQYQYbDYQYbDYbDZo0aNGjRo0aNGjTxo0aNGj+aNGjRo0YEGg0GpAoCgKAr//5QKBQFAgkLGM2bNmzZs2bNGjQgMAYDAYDAYDUh5D///+Q8h/kPIeQ8h//kPIeQ8h5DyHkPIaaIiIiIiImqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqg==";
          successSound.play().catch(e => console.log("Audio play failed", e));
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const finalPunishment = punishmentElement.textContent;
          losersData[loserIndex].punishment = finalPunishment;
          losersData[loserIndex].isSpinning = false;
          usedPunishments.push(finalPunishment);
          
          // ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          const row = document.getElementById(`loser-row-${loserIndex}`);
          if (row) {
            const applyButton = row.querySelector(".btn-success");
            if (applyButton) applyButton.disabled = false;
          }
          
          // Ø¹Ø±Ø¶ Ø²Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„
          document.getElementById("apply-all-btn").style.display = "block";
        }
      }, 100);
    }
    
    // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    function spinAllPunishments() {
      losersData.forEach((loser, index) => {
        if (!loser.applied) {
          setTimeout(() => spinPunishment(index), index * 300);
        }
      });
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù…Ø¹ÙŠÙ†
    function applyPunishment(loserIndex) {
      const loser = losersData[loserIndex];
      if (!loser.punishment || loser.applied) return;
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
      socket.emit("set_final_loser", { loser: loser.name });
      socket.emit("final_apply_punishment", { 
        loser: loser.name, 
        punishment: loser.punishment 
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      loser.applied = true;
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      const row = document.getElementById(`loser-row-${loserIndex}`);
      if (row) {
        const buttons = row.querySelectorAll("button");
        buttons.forEach(btn => {
          btn.disabled = true;
        });
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        row.style.opacity = "0.7";
        row.style.backgroundColor = "#f0f0f0";
      }
      
      // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      const applySound = new Audio();
      applySound.src = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAADAAAHWgCVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZXz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/P///////////////////////////////////////////8AAAA8TEFNRTMuMTAwBK8AAAAAAAAAABSAJAZGkgAAgAAAB1oa2YRnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tAxAAAw8ABeAAAAA1oDzciEABmQAQDgMxHIIPn5+Hv4IFAYDhMJhRCCDDDCCIQQYdD4IMCgQCAIgRBgQCAIAgD8EAQBAEAQBGMYx/iAIAgCAIA+CAIAgCgZYQYEAgCAIAgD4IAgCAILF1EH4fLsIJMJWEGEEDcYsWNP/xYuos6iDCDDYaZ0CgQYQQQQQQQYQYQYbDYQYbDYbDZo0aNGjRo0aNGjTxo0aNGj+aNGjRo0YEGg0GpAoCgKAr//5QKBQFAgkLGM2bNmzZs2bNGjQgMAYDAYDAYDUh5D///+Q8h/kPIeQ8h5D//kPIeQ8h5DyHkPIaaIiIiIiImqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqg==";
      applySound.play().catch(e => console.log("Audio play failed", e));
      
      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
      const flash = document.getElementById("flash-result");
      flash.style.display = "block";
      flash.textContent = `ğŸ¯ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­ÙƒÙ… Ø¹Ù„Ù‰ ${loser.name}: ${loser.punishment}`;
      setTimeout(() => { flash.style.display = "none"; }, 3000);
      
      // ØªØ­Ø¯ÙŠØ« Ø²Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„
      const anyUnapplied = losersData.some(loser => loser.punishment && !loser.applied);
      document.getElementById("apply-all-btn").style.display = anyUnapplied ? "block" : "none";
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    function applyAllPunishments() {
      const unappliedWithPunishment = losersData.filter(
        loser => loser.punishment && !loser.applied
      );
      
      if (unappliedWithPunishment.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­ÙƒØ§Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚!");
        return;
      }
      
      // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª ÙÙŠ Ù…ØµÙÙˆÙØ©
      const allPunishmentsToApply = unappliedWithPunishment.map(loser => ({
        loser: loser.name,
        punishment: loser.punishment
      }));
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù…
      socket.emit("apply_all_punishments", { punishments: allPunishmentsToApply });
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø¬Ù…ÙŠØ¹
      unappliedWithPunishment.forEach(loser => {
        loser.applied = true;
      });
      
      // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
      const allSound = new Audio();
      allSound.src = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAFAAAJrADd3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3f////////////////////////////////////////////////////////////////////////////////////////////////8AAAA8TEFNRTMuMTAwBK8AAAAAAAAAABSAJAaZQwAAgAAACalJ3xA6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAAD0nYNPwwkAJAAAP8AAAABMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==";
      allSound.play().catch(e => console.log("Audio play failed", e));
      
      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      showLosersAndPunishments();
      
      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
      const flash = document.getElementById("flash-result");
      flash.style.display = "block";
      flash.textContent = `âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ${unappliedWithPunishment.length} Ø¹Ù‚ÙˆØ¨Ø§Øª!`;
      
      // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„ÙŠ
      document.getElementById("apply-all-btn").disabled = true;
      document.getElementById("apply-all-btn").style.display = "none";
    }
  </script>
</body>
</html>